sudo: required
language: python
python:
  - "2.7"
dist: xenial
virtualenv:
  system_site_packages: true

notifications:
  email:
    recipients:
      - support@fitbenchmarking.com
    on_success: never
    on_failure: always

stages:
  - name: Tests
  - name: SysTests
    if: type = cron

before_install:
  # Adding RALfit packages
  - sudo apt-get update
  - sudo apt-get install gfortran
  - sudo apt-get install lcov
  - sudo apt-get install libblas-dev
  - sudo apt-get install liblapack-dev
  # Adding gsl pacakges
  - sudo apt-get install libgsl-dev=2.1

install:
  # Builds RALfit
  - ./build_ralfit.sh
  
  - pip install -r requirements.txt
  - python setup.py install
  - python setup.py externals
  
  # To access RALfit
  - export LD_LIBRARY_PATH=$HOME/build/fitbenchmarking/fitbenchmarking/RALFit/libRALFit/build/src:$LD_LIBRARY_PATH


jobs:
  include:
    - stage: Tests
      before_script: python -m mantid.simpleapi || true
      script:
        # ======= Examples Tests =============== #
        - pytest example_scripts/ --cov=example_scripts/
          --cov-report term-missing
        # ======= Fitting Tests =============== #
        - pytest fitbenchmarking/fitting/ --cov=fitbenchmarking/fitting/
          --cov-report term-missing --cov-append
        # ======= Parsing Tests =============== #
        - pytest fitbenchmarking/parsing/tests/ --cov=fitbenchmarking/parsing/
          --cov-report term-missing --cov-append
        # ======= Result Processing Tests =============== #
        - pytest fitbenchmarking/resproc/tests/
          --cov=fitbenchmarking/resproc --cov-report term-missing
          --cov-append
        # ======= Utils Tests =============== #
        - pytest fitbenchmarking/utils/tests/ --cov=fitbenchmarking/utils/
          --cov-report term-missing --cov-append
      after_success:
        - coveralls
  allow_failures:
    - stage: SysTests
      before_script: python -m mantid.simpleapi || true
      script:
        # ======= System Test =============== #
        - cd systests
        - python generate_current_results.py
        - python tbl_comparison.py
